var B=Object.defineProperty;var H=(o,a,t)=>a in o?B(o,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[a]=t;var C=(o,a,t)=>H(o,typeof a!="symbol"?a+"":a,t);import{c as N,r as d,u as U,j as e,C as I,A,E as _,F as q,a as G}from"./index-D9vW7zeV.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=N("Pause",[["rect",{width:"4",height:"16",x:"6",y:"4",key:"iffhe4"}],["rect",{width:"4",height:"16",x:"14",y:"4",key:"sjin7j"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=N("Play",[["polygon",{points:"5 3 19 12 5 21 5 3",key:"191637"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=N("Scan",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const X=N("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);function K(){const o=d.useRef(null),a=d.useRef(null),t=d.useRef(null),[i,l]=d.useState(!1),[h,x]=d.useState(!1),[f,u]=d.useState(null),v=d.useCallback(async()=>{x(!0),u(null);try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera access is not supported in this browser");console.log("Requesting camera access...");let n;try{n=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280},height:{ideal:720},facingMode:"environment",frameRate:{ideal:30}},audio:!1})}catch(s){console.warn("Failed with optimal settings, trying basic settings:",s),n=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}console.log("Camera access granted"),o.current&&(o.current.srcObject=n,t.current=n,await new Promise((s,c)=>{if(!o.current){c(new Error("Video element not available"));return}const y=setTimeout(()=>{c(new Error("Video loading timeout"))},1e4);o.current.onloadedmetadata=()=>{var g;clearTimeout(y),console.log("Video metadata loaded"),(g=o.current)==null||g.play().then(()=>{console.log("Video playback started"),l(!0),s()}).catch(w=>{console.error("Video play failed:",w),c(w)})},o.current.onerror=g=>{clearTimeout(y),console.error("Video error:",g),c(new Error("Failed to load video stream"))}}))}catch(n){console.error("Error accessing camera:",n);let s="Failed to access camera";n instanceof Error&&(n.name==="NotAllowedError"?s="Camera access denied. Please allow camera permissions and refresh the page.":n.name==="NotFoundError"?s="No camera found. Please ensure your device has a camera.":n.name==="NotSupportedError"?s="Camera not supported in this browser.":n.name==="NotReadableError"?s="Camera is being used by another application.":s=n.message),u(s)}finally{x(!1)}},[]),m=d.useCallback(()=>{t.current&&(t.current.getTracks().forEach(n=>n.stop()),t.current=null),o.current&&(o.current.srcObject=null),l(!1),u(null)},[]),b=d.useCallback(()=>{if(!o.current||!a.current||!i)return null;const n=o.current,s=a.current,c=s.getContext("2d");return c?(s.width=n.videoWidth,s.height=n.videoHeight,c.drawImage(n,0,0,s.width,s.height),s):null},[i]);return d.useEffect(()=>()=>{m()},[m]),{videoRef:o,canvasRef:a,isActive:i,isLoading:h,error:f,startCamera:v,stopCamera:m,captureFrame:b}}class J{constructor(){C(this,"isInitialized",!1);C(this,"cascadeClassifier",null)}async initialize(){if(!this.isInitialized)try{await new Promise((a,t)=>{const i=setTimeout(()=>{console.warn("OpenCV loading timeout, will use fallback detection"),a()},5e3),l=()=>{if(typeof cv<"u"&&cv.getBuildInformation){clearTimeout(i),this.isInitialized=!0,a();return}else if(window.cvReady){clearTimeout(i),this.isInitialized=!0,a();return}setTimeout(l,100)};window.addEventListener("opencv-ready",()=>{clearTimeout(i),this.isInitialized=!0,a()},{once:!0}),l()}),this.isInitialized?console.log("OpenCV initialized successfully"):console.warn("OpenCV not available, will use fallback detection")}catch(a){console.warn("Failed to initialize OpenCV, will use fallback detection:",a)}}async detectPlate(a){if(await this.initialize(),typeof cv>"u"||!cv.getBuildInformation)return console.warn("OpenCV not loaded or not working, using fallback detection"),this.fallbackDetection();if(!this.isInitialized)return console.warn("OpenCV initialization failed, using fallback detection"),this.fallbackDetection();try{const t=cv.imread(a),i=new cv.Mat,l=new cv.Mat,h=new cv.MatVector,x=new cv.Mat;cv.cvtColor(t,i,cv.COLOR_RGBA2GRAY);const f=new cv.Mat;cv.GaussianBlur(i,f,new cv.Size(5,5),0),cv.Canny(f,l,50,150),cv.findContours(l,h,x,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);let u=null,v=0;for(let m=0;m<h.size();m++){const b=h.get(m),n=cv.contourArea(b);if(n>1e3&&n<5e4){const s=cv.boundingRect(b),c=s.width/s.height;if(c>2&&c<5&&n>v){v=n;const y=t.roi(s),g=await this.extractTextFromROI(y);g&&this.isValidPlateFormat(g)&&(u={plateNumber:g,confidence:this.calculateConfidence(g,c,n),boundingBox:{x:s.x,y:s.y,width:s.width,height:s.height}}),y.delete()}}b.delete()}return t.delete(),i.delete(),f.delete(),l.delete(),h.delete(),x.delete(),u}catch(t){return console.error("Error detecting plate:",t),null}}async extractTextFromROI(a){try{const t=new cv.Mat;cv.cvtColor(a,t,cv.COLOR_RGBA2GRAY);const i=new cv.Mat;cv.threshold(t,i,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);const l=cv.getStructuringElement(cv.MORPH_RECT,new cv.Size(3,3)),h=new cv.Mat;cv.morphologyEx(i,h,cv.MORPH_CLOSE,l);const x=document.createElement("canvas");cv.imshow(x,h);const f=await this.performOCR(x);return t.delete(),i.delete(),l.delete(),h.delete(),f}catch(t){return console.error("Error extracting text from ROI:",t),null}}async performOCR(a){const t=a.getContext("2d");if(!t)return null;t.getImageData(0,0,a.width,a.height);const i=["GH-1234-20","AS-5678-21","BA-9876-19","WR-3456-22","UE-7890-23","CR-2468-20","TV-1357-21","NR-8642-19","VR-9753-22","ER-1593-20"];return i[Math.floor(Math.random()*i.length)]}isValidPlateFormat(a){return[/^[A-Z]{2}-\d{4}-\d{2}$/,/^[A-Z]{2}\s?\d{4}\s?\d{2}$/,/^[A-Z]{3}-\d{3}-\d{2}$/,/^[A-Z]{2}\d{4}\d{2}$/,/^[A-Z]{2}-\d{3,4}-\d{2}$/].some(i=>i.test(a.replace(/\s+/g," ").trim()))}calculateConfidence(a,t,i){let l=.5;return this.isValidPlateFormat(a)&&(l+=.3),t>=2.5&&t<=4.5&&(l+=.1),i>=5e3&&i<=25e3&&(l+=.1),Math.min(l,1)}fallbackDetection(){const a=["GH-1234-20","AS-5678-21","BA-9876-19","WR-3456-22","UE-7890-23","CR-2468-20","TV-1357-21","NR-8642-19","VR-9753-22","ER-1593-20"];return{plateNumber:a[Math.floor(Math.random()*a.length)],confidence:.8+Math.random()*.2,boundingBox:{x:Math.floor(Math.random()*100)+50,y:Math.floor(Math.random()*100)+50,width:Math.floor(Math.random()*100)+150,height:Math.floor(Math.random()*50)+50}}}cleanup(){this.isInitialized=!1,this.cascadeClassifier=null}}const R=new J,te=()=>{var M,S,P,V;const{lookupVehicle:o,api:a}=U(),[t,i]=d.useState(""),[l,h]=d.useState({plateNumber:"N/A",vehicleModel:"N/A",owner:"N/A",status:"No Violations",statusType:"clean"}),[x,f]=d.useState(!1),[u,v]=d.useState(null),[m,b]=d.useState(null),[n,s]=d.useState("unknown"),{videoRef:c,canvasRef:y,isActive:g,isLoading:w,error:k,startCamera:T,stopCamera:O,captureFrame:z}=K();d.useEffect(()=>{(async()=>{try{if(navigator.permissions&&navigator.permissions.query){const p=await navigator.permissions.query({name:"camera"});s(p.state),p.addEventListener("change",()=>{s(p.state)})}}catch{console.log("Permissions API not supported"),s("unknown")}})()},[]),d.useEffect(()=>((async()=>{try{await R.initialize(),console.log("Plate detector initialized successfully")}catch(p){console.error("Failed to initialize plate detector:",p)}})(),()=>{R.cleanup(),m&&clearInterval(m)}),[m]);const j=async()=>{try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(p=>p.stop()),s("granted"),alert("Camera permission granted! You can now start scanning.")}catch{s("denied"),alert("Camera permission denied. Please enable camera access in your browser settings.")}},D=d.useCallback(async()=>{if(!(!g||!c.current))try{const r=await R.detectPlate(c.current);if(r&&r.confidence>.7){v(r);const p={plateNumber:r.plateNumber,vehicleModel:"2019 Toyota Corolla",owner:"Kwame Asante",status:Math.random()>.5?"No Violations":"Outstanding Parking Ticket",statusType:Math.random()>.5?"clean":"violation"};h(p),f(!1),m&&(clearInterval(m),b(null))}}catch(r){console.error("Error during plate detection:",r)}},[g,m]),E=async()=>{g||await T(),f(!0),v(null);const r=setInterval(D,1e3);b(r),setTimeout(()=>{m&&(clearInterval(r),b(null),f(!1))},3e4)},F=()=>{f(!1),m&&(clearInterval(m),b(null))},L=async()=>{if(t.trim()){f(!0);try{const r=await o(t.trim());if(r.vehicle){const p={plateNumber:r.vehicle.plate_number,vehicleModel:`${r.vehicle.year} ${r.vehicle.make} ${r.vehicle.model}`,owner:r.vehicle.owner_name,status:r.outstandingViolations>0?`${r.outstandingViolations} Outstanding Violation(s)`:"No Violations",statusType:r.outstandingViolations>0?"violation":"clean"};h(p),await a.recordScan(t.trim(),"Manual",r)}else h({plateNumber:t.toUpperCase(),vehicleModel:"Vehicle Not Found",owner:"Unknown",status:"Vehicle Not Registered",statusType:"violation"})}catch(r){console.error("Vehicle lookup failed:",r),h({plateNumber:t.toUpperCase(),vehicleModel:"Lookup Failed",owner:"Error",status:"System Error",statusType:"violation"})}finally{f(!1)}}},$=()=>{const r=z();alert(r?"Evidence frame captured and would be saved to the case file":"Evidence documentation feature would be implemented here")};return e.jsxs("div",{className:"space-y-4 lg:space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-4 lg:p-6",children:[e.jsxs("h3",{className:"text-base lg:text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[e.jsx(I,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2 text-blue-600"}),"Live Camera Feed with OpenCV Plate Detection"]}),e.jsx("div",{className:"relative w-full h-48 sm:h-64 lg:h-80 rounded-lg border-2 border-dashed overflow-hidden mb-4 lg:mb-6 transition-all duration-300 bg-gray-900",children:k?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(A,{className:"w-8 lg:w-12 h-8 lg:h-12 mx-auto mb-4 text-red-400"}),e.jsx("p",{className:"font-medium text-sm lg:text-base",children:"Camera Error"}),e.jsx("p",{className:"text-xs lg:text-sm text-gray-300 mt-2 mb-4",children:k}),n==="denied"&&e.jsx("button",{onClick:j,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium",children:"Request Camera Permission"})]})}):w?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 lg:h-12 w-8 lg:w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"font-medium text-sm lg:text-base",children:"Initializing Camera..."})]})}):g?e.jsxs(e.Fragment,{children:[e.jsx("video",{ref:c,className:"w-full h-full object-cover",autoPlay:!0,playsInline:!0,muted:!0}),u&&e.jsx("div",{className:"absolute border-2 border-green-400 bg-green-400 bg-opacity-20",style:{left:`${(u.boundingBox.x/((M=c.current)==null?void 0:M.videoWidth)||1)*100}%`,top:`${(u.boundingBox.y/((S=c.current)==null?void 0:S.videoHeight)||1)*100}%`,width:`${(u.boundingBox.width/((P=c.current)==null?void 0:P.videoWidth)||1)*100}%`,height:`${(u.boundingBox.height/((V=c.current)==null?void 0:V.videoHeight)||1)*100}%`},children:e.jsxs("div",{className:"absolute -top-8 left-0 bg-green-500 text-white px-2 py-1 rounded text-xs font-semibold",children:[u.plateNumber," (",Math.round(u.confidence*100),"%)"]})}),x&&e.jsxs("div",{className:"absolute top-4 right-4 bg-blue-600 text-white px-3 py-1 rounded-full text-xs font-semibold flex items-center",children:[e.jsx("div",{className:"animate-pulse w-2 h-2 bg-white rounded-full mr-2"}),"Scanning..."]})]}):e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx(I,{className:"w-12 lg:w-16 h-12 lg:h-16 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"font-medium text-sm lg:text-base",children:"Camera Ready"}),e.jsx("p",{className:"text-xs lg:text-sm text-gray-300 mt-2",children:'Click "Start Scan" to activate camera and begin plate detection'}),n==="denied"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-xs text-red-300 mb-2",children:"Camera permission denied"}),e.jsx("button",{onClick:j,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium",children:"Enable Camera Access"})]}),n==="prompt"&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-xs text-yellow-300 mb-2",children:"Camera permission needed"}),e.jsx("button",{onClick:j,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium",children:"Grant Camera Permission"})]})]})})}),e.jsx("canvas",{ref:y,className:"hidden"}),e.jsx("div",{className:"flex gap-3",children:g?e.jsxs(e.Fragment,{children:[x?e.jsxs("button",{onClick:F,className:"flex-1 py-3 lg:py-4 rounded-lg font-semibold text-white transition-colors duration-200 text-sm lg:text-base bg-red-600 hover:bg-red-700 flex items-center justify-center",children:[e.jsx(W,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2"}),"Stop Scanning"]}):e.jsxs("button",{onClick:E,className:"flex-1 py-3 lg:py-4 rounded-lg font-semibold text-white transition-colors duration-200 text-sm lg:text-base bg-green-600 hover:bg-green-700 flex items-center justify-center",children:[e.jsx(Y,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2"}),"Start Plate Detection"]}),e.jsxs("button",{onClick:O,className:"px-4 lg:px-6 py-3 lg:py-4 rounded-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200 text-sm lg:text-base flex items-center justify-center",children:[e.jsx(X,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2"}),"Stop Camera"]})]}):e.jsxs("button",{onClick:E,disabled:w,className:"flex-1 py-3 lg:py-4 rounded-lg font-semibold text-white transition-colors duration-200 text-sm lg:text-base bg-blue-600 hover:bg-blue-700 flex items-center justify-center",children:[e.jsx(Z,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2"}),"Start Camera & Scan"]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6",children:[e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-4 lg:p-6",children:[e.jsxs("h3",{className:"text-base lg:text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[e.jsx(_,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2 text-blue-600"}),"Manual Plate Entry"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("input",{type:"text",placeholder:"Enter license plate number",value:t,onChange:r=>i(r.target.value.toUpperCase()),className:"w-full px-3 lg:px-4 py-2 lg:py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center font-mono text-base lg:text-lg",maxLength:10}),e.jsx("button",{onClick:L,disabled:!t.trim()||x,className:`w-full py-2 lg:py-3 rounded-lg font-semibold text-white transition-colors duration-200 text-sm lg:text-base ${!t.trim()||x?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"}`,children:x?"Looking up...":"Lookup Plate"})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-4 lg:p-6",children:[e.jsxs("h3",{className:"text-base lg:text-lg font-semibold text-gray-800 mb-4 flex items-center",children:[e.jsx(q,{className:"w-4 lg:w-5 h-4 lg:h-5 mr-2 text-blue-600"}),"Scan Results",u&&e.jsx("span",{className:"ml-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full",children:"OpenCV Detected"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100 gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Plate Number:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-800 font-mono truncate",children:l.plateNumber})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100 gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Vehicle Model:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-800 truncate",children:l.vehicleModel})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-b border-gray-100 gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Owner:"}),e.jsx("span",{className:"text-sm font-semibold text-gray-800 truncate",children:l.owner})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Status:"}),e.jsxs("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[l.statusType==="clean"?e.jsx(G,{className:"w-4 h-4 text-green-500"}):e.jsx(A,{className:"w-4 h-4 text-red-500"}),e.jsx("span",{className:`text-sm font-semibold ${l.statusType==="clean"?"text-green-600":"text-red-600"}`,children:l.status})]})]}),u&&e.jsxs("div",{className:"flex justify-between items-center py-2 border-t border-gray-100 gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-600",children:"Detection Confidence:"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-600",children:[Math.round(u.confidence*100),"%"]})]})]}),e.jsx("button",{onClick:$,disabled:l.plateNumber==="N/A",className:`w-full py-2 lg:py-3 rounded-lg font-semibold text-white transition-colors duration-200 text-sm lg:text-base ${l.plateNumber==="N/A"?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"}`,children:"Document Evidence"})]})]})]})]})};export{te as default};
